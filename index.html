<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hogwarts Feast Tracker ⚡</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, #0c1445 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      font-family: 'Crimson Text', serif;
      min-height: 100vh;
      animation: fadeIn 1s ease-in;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes sparkle { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.1) rotate(5deg); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } }
    @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(-10px); } }
    
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 2s infinite;
    }
    
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    
    header {
      position: relative;
      z-index: 10;
      padding: 30px 20px;
      text-align: center;
      background: linear-gradient(135deg, #7f0909, #d4af37, #0a1172);
      border-bottom: 3px solid #ffd700;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
    
    h1 {
      font-family: 'Cinzel', serif;
      margin: 0;
      font-weight: 900;
      font-size: 3rem;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
      background: linear-gradient(45deg, #ffd700, #fff, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      font-size: 1.2rem;
      margin-top: 10px;
      font-style: italic;
      color: #ffd700;
    }
    
    .main-container {
      position: relative;
      z-index: 10;
      max-width: 1600px;
      margin: 30px auto;
      padding: 0 20px 150px;
      display: grid;
      gap: 25px;
      grid-template-columns: 1fr 1fr 350px 350px;
    }
    
    .magical-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .magical-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
      transform: rotate(-45deg);
      transition: all 0.6s ease;
      opacity: 0;
    }
    
    .magical-card:hover::before {
      opacity: 1;
      transform: rotate(-45deg) translate(50%, 50%);
    }
    
    .magical-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 215, 0, 0.6);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    
    .card-title {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      color: #ffd700;
      margin: 0 0 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .magical-input, .magical-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 10px;
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .magical-input:focus, .magical-select:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }
    
    .magical-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(45deg, #7f0909, #d4af37);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      position: relative;
      overflow: hidden;
    }
    
    .magical-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }
    
    .magical-btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .magical-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .feast-log {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .feast-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 10px;
      transition: all 0.3s ease;
      animation: floatUp 0.5s ease;
    }
    
    .feast-item:hover {
      background: rgba(255,215,0,0.2);
      transform: translateX(5px);
    }
    
    .magic-meter {
      height: 25px;
      background: linear-gradient(90deg, #000, #333);
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0;
      border: 2px solid #ffd700;
      position: relative;
    }
    
    .magic-fill {
      height: 100%;
      background: linear-gradient(90deg, #7f0909, #d4af37, #0a1172);
      transition: width 0.8s ease;
      border-radius: 15px;
      position: relative;
    }
    
    .magic-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .status-good { color: #4CAF50; font-weight: bold; }
    .status-warning { color: #FF9800; font-weight: bold; }
    .status-danger { color: #F44336; font-weight: bold; }
    
    .trophy-case {
      background: linear-gradient(145deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
      border: 3px solid #ffd700;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .trophy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .trophy-item {
      text-align: center;
      padding: 15px;
      background: rgba(255,215,0,0.1);
      border: 2px solid rgba(255,215,0,0.3);
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .trophy-item:hover {
      transform: scale(1.05);
      background: rgba(255,215,0,0.2);
      animation: glow 1s infinite;
    }
    
    .trophy-emoji {
      font-size: 2.5rem;
      display: block;
      margin-bottom: 8px;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
    }
    
    .trophy-owned .trophy-emoji {
      animation: sparkle 2s infinite;
    }
    
    .trophy-cost {
      font-size: 0.9rem;
      color: #ffd700;
      font-weight: bold;
    }
    
    .trophy-owned .trophy-cost {
      color: #4CAF50;
    }
    
    .owned-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .owned-trophy {
      text-align: center;
      padding: 10px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      border-radius: 10px;
      color: #000;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(255,215,0,0.3);
      animation: glow 3s infinite;
    }
    
    /* Simple Game Styles */
    .game-cell {
      display: inline-block;
      width: 40px;
      height: 40px;
      margin: 2px;
      text-align: center;
      line-height: 40px;
      font-size: 1.8rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      border: 2px solid rgba(255,215,0,0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }
    
    .game-cell:hover {
      transform: scale(1.1);
      border-color: rgba(255,215,0,0.8);
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    
    .game-cell.selected {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      box-shadow: 0 0 20px rgba(255,215,0,0.8);
    }
    
    .game-cell.matched {
      animation: gameMatch 0.8s ease-in-out forwards;
    }
    
    @keyframes gameMatch {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); background: #ff6b6b; }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .motivation-quote {
      text-align: center;
      font-style: italic;
      color: #ffd700;
      font-size: 1.1rem;
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,215,0,0.1);
      border-radius: 10px;
      border: 1px solid rgba(255,215,0,0.3);
    }
    
    .magical-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(45deg, #7f0909, #d4af37);
      color: #fff;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
    }
    
    .magical-toast.show {
      transform: translateX(0);
    }
    
    .house-badge {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin: 5px;
    }
    
    .level-display {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .points-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .calorie-estimate {
      background: rgba(255,215,0,0.2);
      border: 1px solid #ffd700;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-weight: bold;
      color: #ffd700;
    }
    
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    @media (max-width: 900px) {
      .main-container {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  
  <header>
    <h1 id="header-title">Hogwarts Feast Tracker ⚡</h1>
    <div class="subtitle">Master the Art of Magical Nutrition</div>
    <p>Chronicle your daily feasts, balance your magical energy (1800-2200 calories), earn house points, and unlock legendary artifacts!</p>
  </header>

  <div class="main-container">
    <!-- Food Input Section -->
    <div class="magical-card">
      <h2 class="card-title">🪄 Conjure Your Feast</h2>
      <p>Simply whisper what delicious morsel you've enjoyed, and our ancient grimoire will divine its magical essence!</p>
      
      <div class="input-group">
        <select id="meal-time" class="magical-select">
          <option value="Custom">Any Magical Moment</option>
          <option value="Breakfast">Breakfast in the Great Hall</option>
          <option value="Morning Snack">Morning Potion Break</option>
          <option value="Lunch">Midday Feast with Friends</option>
          <option value="Afternoon Snack">Afternoon Enchantment</option>
          <option value="Dinner">Evening Grand Banquet</option>
          <option value="Late Snack">Midnight Kitchen Raid</option>
        </select>
      </div>
      
      <div class="input-group">
        <input id="food-name" class="magical-input" placeholder="What magical feast did you enjoy? (e.g., roasted chicken, chocolate cake, apple)" />
      </div>
      
      <div class="input-group">
        <input id="food-calories" class="magical-input" placeholder="Calories (leave empty for auto-divination)" type="number" />
      </div>
      
      <div id="calorie-suggestion" class="calorie-estimate" style="display: none;"></div>
      
      <button id="estimate-btn" class="magical-btn">🔮 Divine Calories</button>
      <button id="add-btn" class="magical-btn">✨ Add to Feast Log</button>
    </div>

    <!-- Daily Log Section -->
    <div class="magical-card">
      <h2 class="card-title">📜 Today's Magical Chronicle</h2>
      <div id="feast-log" class="feast-log"></div>
      <div style="text-align: center; margin-top: 20px;">
        <button id="clear-log" class="magical-btn">🌟 New Day Incantation</button>
      </div>
    </div>

    <!-- Match-3 Magical Game -->
    <div class="magical-card">
      <h2 class="card-title">🎮 Magical Potions Match</h2>
      <p>Match 3+ magical items to earn house points!</p>
      <div style="text-align: center; margin-bottom: 15px;">
        <div><strong>Score:</strong> <span id="game-score">0</span> | <strong>Moves:</strong> <span id="moves-left">15</span></div>
      </div>
      
      <div style="text-align: center;">
        <div id="game-board" style="display: inline-block; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; border: 2px solid #ffd700;">
          <!-- Game will load here -->
        </div>
        
        <div style="margin-top: 15px;">
          <button id="new-game" class="magical-btn" onclick="initGame()">🆕 New Game</button>
          <button class="magical-btn" onclick="getGameHint()">💡 Hint (5 pts)</button>
        </div>
        <div id="game-status" style="color: #ffd700; margin-top: 10px; font-weight: bold;">Click New Game to start!</div>
      </div>
    </div>

    <!-- Stats and Progress Sidebar -->
    <div>
      <!-- Magic Meter -->
      <div class="magical-card">
        <h2 class="card-title">⚡ Daily Magic Meter</h2>
        <div class="magic-meter">
          <div id="magic-fill" class="magic-fill"></div>
        </div>
        <p><strong>Total Energy:</strong> <span id="total-calories" class="points-display">0</span> calories</p>
        <p><strong>Feast Items:</strong> <span id="total-items">0</span></p>
        <p id="status-message" class="status-good">Ready for magical adventures!</p>
        <div id="motivation" class="motivation-quote"></div>
      </div>

      <!-- House Points & Level -->
      <div class="magical-card">
        <h2 class="card-title">🏆 House Championship</h2>
        <div id="house-selection" style="display: none;">
          <p>🏰 Choose Your Hogwarts House:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
            <button class="magical-btn house-btn" data-house="Gryffindor">🦁 Gryffindor</button>
            <button class="magical-btn house-btn" data-house="Hufflepuff">🦡 Hufflepuff</button>
            <button class="magical-btn house-btn" data-house="Ravenclaw">🦅 Ravenclaw</button>
            <button class="magical-btn house-btn" data-house="Slytherin">🐍 Slytherin</button>
          </div>
        </div>
        <div id="house-display">
          <p><strong>Your House:</strong> <span id="house-name" class="house-badge">Choose your house!</span></p>
          <p><strong>House Points:</strong> <span id="house-points" class="points-display">0</span></p>
          <p><strong>Wizard Level:</strong> <span id="wizard-level" class="level-display">Apprentice (1)</span></p>
          <button id="change-house" class="magical-btn" style="font-size: 0.8rem; padding: 5px 10px;">Change House</button>
        </div>
        <button id="daily-bonus" class="magical-btn">🧪 Claim Daily Elixir (50 pts)</button>
      </div>

      <!-- Trophy Shop -->
      <div class="magical-card">
        <h2 class="card-title">🏪 Magical Artifacts Shop</h2>
        <p>Transmute your hard-earned points into legendary treasures!</p>
        <div id="trophy-shop" class="trophy-grid"></div>
      </div>

      <!-- Trophy Case -->
      <div class="magical-card">
        <h2 class="card-title">🎖️ Your Trophy Case</h2>
        <p>Behold your collection of magical artifacts!</p>
        <div id="trophy-case" class="owned-display"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="magical-toast"></div>

  <script>
    // Configuration and Constants
    const CONFIG = {
      TARGET_MIN: 1800,
      TARGET_MAX: 2200,
      STORAGE_KEY: 'hogwarts_feast_tracker',
      HOUSES: ['Gryffindor', 'Hufflepuff', 'Ravenclaw', 'Slytherin'],
      HOUSE_COLORS: {
        'Gryffindor': '#7f0909',
        'Hufflepuff': '#d4af37', 
        'Ravenclaw': '#0a1172',
        'Slytherin': '#0d6217'
      },
      HOUSE_EMOJIS: {
        'Gryffindor': '🦁',
        'Hufflepuff': '🦡',
        'Ravenclaw': '🦅',
        'Slytherin': '🐍'
      }
    };

    // Expanded Calorie Database
    const CALORIE_DB = {
      // Proteins
      'chicken breast': 165, 'chicken thigh': 209, 'turkey': 189, 'beef': 250, 'pork': 242,
      'salmon': 206, 'tuna': 132, 'cod': 82, 'shrimp': 99, 'crab': 97, 'eggs': 155,
      'egg whites': 52, 'tofu': 70, 'tempeh': 193, 'chicken': 165, 'beef steak': 271,
      'ground beef': 254, 'lamb': 294, 'bacon': 541, 'ham': 145, 'sausage': 346,
      
      // Carbohydrates  
      'rice': 130, 'quinoa': 120, 'pasta': 131, 'bread': 265, 'oats': 389, 'cereal': 379,
      'potato': 77, 'sweet potato': 86, 'corn': 96, 'barley': 123, 'bulgur': 83,
      'couscous': 112, 'noodles': 138, 'bagel': 245, 'muffin': 377, 'pancakes': 227,
      
      // Fruits
      'apple': 52, 'banana': 89, 'orange': 47, 'grapes': 67, 'strawberries': 32,
      'blueberries': 57, 'raspberries': 52, 'blackberries': 43, 'pineapple': 50,
      'mango': 60, 'peach': 39, 'pear': 57, 'plum': 46, 'watermelon': 30,
      'cantaloupe': 34, 'honeydew': 36, 'kiwi': 61, 'papaya': 43, 'avocado': 160,
      
      // Vegetables
      'broccoli': 34, 'spinach': 23, 'kale': 33, 'carrots': 41, 'bell peppers': 31,
      'tomatoes': 18, 'cucumber': 16, 'lettuce': 15, 'onion': 40, 'garlic': 149,
      'mushrooms': 22, 'asparagus': 20, 'green beans': 31, 'peas': 81, 'brussels sprouts': 43,
      'cauliflower': 25, 'cabbage': 25, 'zucchini': 17, 'eggplant': 25, 'beets': 43,
      
      // Dairy & Alternatives
      'milk': 42, 'yogurt': 59, 'cheese': 113, 'cottage cheese': 98, 'cream cheese': 342,
      'butter': 717, 'almond milk': 17, 'soy milk': 33, 'coconut milk': 230, 'ice cream': 207,
      
      // Nuts & Seeds
      'almonds': 579, 'walnuts': 654, 'peanuts': 567, 'cashews': 553, 'pistachios': 560,
      'peanut butter': 588, 'almond butter': 614, 'sunflower seeds': 584, 'chia seeds': 486,
      'flax seeds': 534, 'pumpkin seeds': 446, 'sesame seeds': 573,
      
      // Common Foods
      'pizza': 266, 'burger': 354, 'sandwich': 215, 'salad': 33, 'soup': 36,
      'french fries': 365, 'chips': 536, 'crackers': 488, 'cookies': 502, 'cake': 257,
      'chocolate': 546, 'candy': 400, 'granola bar': 471, 'protein bar': 384,
      'smoothie': 63, 'juice': 45, 'soda': 41, 'beer': 43, 'wine': 83, 'coffee': 2, 'tea': 1
    };

    // Magical Artifacts (Trophies)
    const MAGICAL_ARTIFACTS = [
      { name: 'Chocolate Frog', emoji: '🐸', cost: 25, description: 'Your first magical treat from Honeydukes!' },
      { name: 'Butterbeer Mug', emoji: '🍺', cost: 100, description: 'Perfect for Three Broomsticks celebrations!' },
      { name: 'Quidditch Snitch', emoji: '🏐', cost: 250, description: 'The seeker\'s ultimate prize!' },
      { name: 'House Scarf', emoji: '🧣', cost: 400, description: 'Show your house colors with pride!' },
      { name: 'Wizard\'s Wand', emoji: '🪄', cost: 750, description: '11 inches, phoenix feather core!' },
      { name: 'Sorting Hat', emoji: '🎩', cost: 1000, description: 'Holds the wisdom of Hogwarts founders!' },
      { name: 'Marauder\'s Map', emoji: '🗺️', cost: 1500, description: 'I solemnly swear I am up to no good!' },
      { name: 'Invisibility Cloak', emoji: '👻', cost: 2000, description: 'One of the Deathly Hallows!' },
      { name: 'Time Turner', emoji: '⏰', cost: 3000, description: 'Turn back time with Hermione\'s device!' },
      { name: 'Elder Wand', emoji: '⚡', cost: 5000, description: 'The most powerful wand in existence!' },
      { name: 'Philosopher\'s Stone', emoji: '💎', cost: 10000, description: 'Nicolas Flamel\'s legendary creation!' }
    ];

    // Motivational Messages
    const MOTIVATIONAL_MESSAGES = [
      "Brilliant feast planning! Even Hermione would be impressed! 📚✨",
      "You're showing the dedication of a true Gryffindor! 🦁⚡",
      "Magical balance achieved! Your potion-making skills are legendary! 🧪",
      "Outstanding! Professor McGonagall awards you full marks! 🏆",
      "Your feast log is more organized than the Hogwarts library! 📖",
      "Dumbledore himself would applaud your commitment! 🧙‍♂️✨",
      "You're mastering the art of magical nutrition! Keep soaring! 🦅",
      "Like brewing a perfect Polyjuice Potion - precise and powerful! 💫",
      "Your dedication rivals that of the greatest Hogwarts students! 🌟",
      "Accio success! You're on the path to wizarding greatness! ⚡🪄"
    ];

    // Simple Match-3 Game Variables
    let gameGrid = [];
    let gameSelected = null;
    let gamePoints = 0;
    let gameMoves = 15;
    const gamePieces = ['🧪', '⚡', '🔮', '🕯️', '⭐', '💎'];
    const gridSize = 6;

    // Game State
    let gameState = {
      house: null,
      points: 0,
      level: 1,
      dailyLog: [],
      ownedArtifacts: [],
      lastBonusClaim: null,
      totalCalories: 0,
      totalItems: 0
    };

    // DOM Elements
    const elements = {
      mealTime: document.getElementById('meal-time'),
      foodName: document.getElementById('food-name'),
      foodCalories: document.getElementById('food-calories'),
      calorieEst: document.getElementById('calorie-suggestion'),
      estimateBtn: document.getElementById('estimate-btn'),
      addBtn: document.getElementById('add-btn'),
      feastLog: document.getElementById('feast-log'),
      clearLog: document.getElementById('clear-log'),
      magicFill: document.getElementById('magic-fill'),
      totalCalories: document.getElementById('total-calories'),
      totalItems: document.getElementById('total-items'),
      statusMessage: document.getElementById('status-message'),
      motivation: document.getElementById('motivation'),
      houseName: document.getElementById('house-name'),
      housePoints: document.getElementById('house-points'),
      wizardLevel: document.getElementById('wizard-level'),
      dailyBonus: document.getElementById('daily-bonus'),
      trophyShop: document.getElementById('trophy-shop'),
      trophyCase: document.getElementById('trophy-case'),
      toast: document.getElementById('toast'),
      headerTitle: document.getElementById('header-title'),
      houseSelection: document.getElementById('house-selection'),
      houseDisplay: document.getElementById('house-display'),
      changeHouse: document.getElementById('change-house')
    };

    // Initialize the app
    function init() {
      createStars();
      loadGameState();
      setupEventListeners();
      updateDisplay();
      renderTrophyShop();
      renderTrophyCase();
      showHouseSelection();
      // Game will initialize when user clicks "New Game"
    }

    // Create twinkling stars background
    function createStars() {
      const starsContainer = document.getElementById('stars');
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
      }
    }

    // Show/hide house selection
    function showHouseSelection() {
      if (!gameState.house) {
        elements.houseSelection.style.display = 'block';
        elements.houseDisplay.style.display = 'none';
      } else {
        elements.houseSelection.style.display = 'none';
        elements.houseDisplay.style.display = 'block';
        updateHouseDisplay();
      }
    }

    // Select house
    function selectHouse(houseName) {
      gameState.house = houseName;
      saveGameState();
      updateHouseDisplay();
      showHouseSelection();
      showToast(`🎉 Welcome to ${houseName}! Your magical journey begins now!`);
    }

    // Update house display
    function updateHouseDisplay() {
      if (gameState.house) {
        const emoji = CONFIG.HOUSE_EMOJIS[gameState.house];
        const color = CONFIG.HOUSE_COLORS[gameState.house];
        
        elements.houseName.textContent = `${emoji} ${gameState.house}`;
        elements.houseName.style.backgroundColor = color;
        elements.headerTitle.textContent = `Hogwarts Feast Tracker ${emoji}`;
        
        // Update header background
        document.querySelector('header').style.background = 
          `linear-gradient(135deg, ${color}, #d4af37, #0a1172)`;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      elements.estimateBtn.addEventListener('click', estimateCalories);
      elements.addBtn.addEventListener('click', addToLog);
      elements.clearLog.addEventListener('click', clearDailyLog);
      elements.dailyBonus.addEventListener('click', claimDailyBonus);
      elements.changeHouse.addEventListener('click', () => {
        elements.houseSelection.style.display = 'block';
        elements.houseDisplay.style.display = 'none';
      });
      
      // House selection buttons
      document.querySelectorAll('.house-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const house = e.target.dataset.house;
          selectHouse(house);
        });
      });
      
      // Auto-estimate on input
      elements.foodName.addEventListener('input', () => {
        if (elements.foodName.value.trim()) {
          setTimeout(estimateCalories, 500);
        }
      });
    }

    // Enhanced calorie estimation
    function estimateCalories() {
      const foodName = elements.foodName.value.trim().toLowerCase();
      if (!foodName) {
        showToast('🔮 Tell me what magical feast you enjoyed first!');
        return;
      }

      let estimatedCalories = 0;
      let matchedFood = '';
      let maxMatch = 0;

      // Find best match in database
      for (const [food, calories] of Object.entries(CALORIE_DB)) {
        if (foodName.includes(food) && food.length > maxMatch) {
          maxMatch = food.length;
          estimatedCalories = calories;
          matchedFood = food;
        }
      }

      // Fallback estimation based on food type keywords
      if (!estimatedCalories) {
        if (foodName.includes('chocolate') || foodName.includes('cake') || foodName.includes('cookie')) {
          estimatedCalories = 400;
          matchedFood = 'sweet treat';
        } else if (foodName.includes('salad') || foodName.includes('vegetables')) {
          estimatedCalories = 50;
          matchedFood = 'fresh vegetables';
        } else if (foodName.includes('meat') || foodName.includes('chicken') || foodName.includes('beef')) {
          estimatedCalories = 200;
          matchedFood = 'protein source';
        } else if (foodName.includes('fruit')) {
          estimatedCalories = 60;
          matchedFood = 'fresh fruit';
        } else {
          estimatedCalories = 150;
          matchedFood = 'general food item';
        }
      }

      elements.foodCalories.value = estimatedCalories;
      elements.calorieEst.style.display = 'block';
      elements.calorieEst.innerHTML = `🔮 Ancient grimoire suggests: <strong>${estimatedCalories} calories</strong><br>
        <small>Based on: ${matchedFood}</small>`;
      
      showToast(`✨ Calories divined: ${estimatedCalories} for "${matchedFood}"!`);
    }

    // Add food to log
    function addToLog() {
      const mealTime = elements.mealTime.value;
      const foodName = elements.foodName.value.trim();
      const calories = parseInt(elements.foodCalories.value) || 0;

      if (!foodName) {
        showToast('🪄 Cast your food name into the magical field first!');
        return;
      }

      if (calories <= 0) {
        showToast('🔮 Let me divine the calories first!');
        estimateCalories();
        return;
      }

      // Check for forbidden ingredients (allergens)
      const forbiddenIngredients = ['walnut', 'shellfish', 'onion', 'garlic', 'dairy'];
      const containsForbidden = forbiddenIngredients.some(ingredient => 
        foodName.toLowerCase().includes(ingredient)
      );

      if (containsForbidden) {
        showToast('🛡️ Protective charm activated! This contains forbidden ingredients for your quest.');
        return;
      }

      const logEntry = {
        id: Date.now(),
        mealTime,
        foodName,
        calories,
        timestamp: new Date().toLocaleTimeString()
      };

      gameState.dailyLog.push(logEntry);
      gameState.points += 10;
      updateTotalStats();
      saveGameState();
      updateDisplay();
      clearInputs();
      
      showToast(`🎉 ${foodName} added to your feast log! +10 house points!`);
    }

    // Update total statistics
    function updateTotalStats() {
      gameState.totalCalories = gameState.dailyLog.reduce((sum, entry) => sum + entry.calories, 0);
      gameState.totalItems = gameState.dailyLog.length;
      gameState.level = Math.floor(gameState.points / 500) + 1;
    }

    // Clear input fields
    function clearInputs() {
      elements.foodName.value = '';
      elements.foodCalories.value = '';
      elements.calorieEst.style.display = 'none';
    }

    // Remove item from log
    function removeFromLog(itemId) {
      const index = gameState.dailyLog.findIndex(entry => entry.id === itemId);
      if (index !== -1) {
        gameState.dailyLog.splice(index, 1);
        gameState.points = Math.max(0, gameState.points - 10);
        updateTotalStats();
        saveGameState();
        updateDisplay();
        showToast('🗑️ Item banished from your log... -10 points');
      }
    }

    // Clear daily log
    function clearDailyLog() {
      if (confirm('🌅 Cast a new day incantation? This will clear your feast log but preserve your points and artifacts!')) {
        gameState.dailyLog = [];
        gameState.lastBonusClaim = null;
        updateTotalStats();
        saveGameState();
        updateDisplay();
        showToast('🌟 A new magical day dawns at Hogwarts!');
      }
    }

    // Claim daily bonus
    function claimDailyBonus() {
      const today = new Date().toDateString();
      const isInRange = gameState.totalCalories >= CONFIG.TARGET_MIN && 
                       gameState.totalCalories <= CONFIG.TARGET_MAX;
      const hasEnoughItems = gameState.totalItems >= 5;
      const canClaim = gameState.lastBonusClaim !== today;

      if (isInRange && hasEnoughItems && canClaim) {
        gameState.points += 50;
        gameState.lastBonusClaim = today;
        saveGameState();
        updateDisplay();
        showToast('🧪 Daily Elixir claimed! +50 points to your house! Well done!');
      } else if (!canClaim) {
        showToast('⏰ You\'ve already claimed today\'s elixir! Return tomorrow!');
      } else if (!isInRange) {
        showToast('⚖️ Balance your magical energy within 1800-2200 calories first!');
      } else {
        showToast('📝 Log at least 5 feast items to claim your daily elixir!');
      }
    }

    // Purchase artifact
    function purchaseArtifact(artifactIndex) {
      const artifact = MAGICAL_ARTIFACTS[artifactIndex];
      if (gameState.points >= artifact.cost && !gameState.ownedArtifacts.includes(artifactIndex)) {
        gameState.points -= artifact.cost;
        gameState.ownedArtifacts.push(artifactIndex);
        saveGameState();
        updateDisplay();
        renderTrophyShop();
        renderTrophyCase();
        showToast(`🎉 ${artifact.emoji} ${artifact.name} acquired! ${artifact.description}`);
      } else if (gameState.ownedArtifacts.includes(artifactIndex)) {
        showToast('✨ You already possess this magical artifact!');
      } else {
        showToast(`💰 You need ${artifact.cost - gameState.points} more points for this artifact!`);
      }
    }

    // Render trophy shop
    function renderTrophyShop() {
      elements.trophyShop.innerHTML = '';
      MAGICAL_ARTIFACTS.forEach((artifact, index) => {
        const isOwned = gameState.ownedArtifacts.includes(index);
        const canAfford = gameState.points >= artifact.cost;
        
        const trophyDiv = document.createElement('div');
        trophyDiv.className = `trophy-item ${isOwned ? 'trophy-owned' : ''}`;
        trophyDiv.innerHTML = `
          <span class="trophy-emoji">${artifact.emoji}</span>
          <div style="font-size: 0.8rem; margin-bottom: 5px;">${artifact.name}</div>
          <div class="trophy-cost">${isOwned ? '✅ Owned' : `${artifact.cost} pts`}</div>
        `;
        
        if (!isOwned) {
          trophyDiv.style.opacity = canAfford ? '1' : '0.5';
          trophyDiv.addEventListener('click', () => purchaseArtifact(index));
        }
        
        elements.trophyShop.appendChild(trophyDiv);
      });
    }

    // Render trophy case
    function renderTrophyCase() {
      elements.trophyCase.innerHTML = '';
      if (gameState.ownedArtifacts.length === 0) {
        elements.trophyCase.innerHTML = '<p style="text-align: center; color: #888;">Your magical collection awaits your first artifact!</p>';
        return;
      }

      gameState.ownedArtifacts.forEach(artifactIndex => {
        const artifact = MAGICAL_ARTIFACTS[artifactIndex];
        const trophyDiv = document.createElement('div');
        trophyDiv.className = 'owned-trophy';
        trophyDiv.innerHTML = `
          <div style="font-size: 2rem;">${artifact.emoji}</div>
          <div style="font-size: 0.8rem;">${artifact.name}</div>
        `;
        trophyDiv.title = artifact.description;
        elements.trophyCase.appendChild(trophyDiv);
      });
    }

    // Update all displays
    function updateDisplay() {
      updateHouseDisplay();
      renderFeastLog();
      updateMagicMeter();
      updateStats();
      updateMotivation();
      renderTrophyShop();
      renderTrophyCase();
    }

    // Render feast log
    function renderFeastLog() {
      elements.feastLog.innerHTML = '';
      
      if (gameState.dailyLog.length === 0) {
        elements.feastLog.innerHTML = '<p style="text-align: center; color: #888;">Your magical feast log awaits your first entry!</p>';
        return;
      }

      gameState.dailyLog.forEach(entry => {
        const logDiv = document.createElement('div');
        logDiv.className = 'feast-item';
        logDiv.innerHTML = `
          <div>
            <strong>${entry.mealTime}:</strong> ${entry.foodName}<br>
            <small>${entry.timestamp} • ${entry.calories} calories</small>
          </div>
          <button onclick="removeFromLog(${entry.id})" class="magical-btn" style="background: #7f0909;">✖</button>
        `;
        elements.feastLog.appendChild(logDiv);
      });
    }

    // Update magic meter
    function updateMagicMeter() {
      const percentage = Math.min(100, (gameState.totalCalories / 3000) * 100);
      elements.magicFill.style.width = percentage + '%';
    }

    // Update stats display
    function updateStats() {
      elements.totalCalories.textContent = gameState.totalCalories;
      elements.totalItems.textContent = gameState.totalItems;
      elements.housePoints.textContent = gameState.points;
      elements.wizardLevel.textContent = `Level ${gameState.level}`;

      // Update status message
      if (gameState.totalCalories < CONFIG.TARGET_MIN) {
        elements.statusMessage.textContent = '⚡ Summon more magical energy to your feast!';
        elements.statusMessage.className = 'status-warning';
      } else if (gameState.totalCalories > CONFIG.TARGET_MAX) {
        elements.statusMessage.textContent = '🔥 Powerful magic! Consider balancing your feast.';
        elements.statusMessage.className = 'status-warning';
      } else {
        elements.statusMessage.textContent = '✨ Perfect magical balance achieved!';
        elements.statusMessage.className = 'status-good';
      }

      // Update daily bonus button
      const today = new Date().toDateString();
      const canClaim = gameState.lastBonusClaim !== today &&
                      gameState.totalCalories >= CONFIG.TARGET_MIN &&
                      gameState.totalCalories <= CONFIG.TARGET_MAX &&
                      gameState.totalItems >= 5;
      
      elements.dailyBonus.disabled = !canClaim;
      elements.dailyBonus.textContent = canClaim ? '🧪 Claim Daily Elixir (50 pts)' : 
        gameState.lastBonusClaim === today ? '✅ Elixir Claimed Today' : '🧪 Complete Daily Quest First';
    }

    // Update motivation message
    function updateMotivation() {
      if (gameState.totalCalories >= CONFIG.TARGET_MIN && gameState.totalCalories <= CONFIG.TARGET_MAX) {
        const randomMessage = MOTIVATIONAL_MESSAGES[Math.floor(Math.random() * MOTIVATIONAL_MESSAGES.length)];
        elements.motivation.textContent = randomMessage;
        elements.motivation.style.display = 'block';
      } else {
        elements.motivation.style.display = 'none';
      }
    }

    // Show toast notification
    function showToast(message) {
      elements.toast.textContent = message;
      elements.toast.classList.add('show');
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 3000);
    }

    // Save game state to localStorage
    function saveGameState() {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(gameState));
    }

    // Load game state from localStorage
    function loadGameState() {
      const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (saved) {
        gameState = { ...gameState, ...JSON.parse(saved) };
        updateTotalStats();
      }
    }

    // Make removeFromLog globally accessible
    window.removeFromLog = removeFromLog;

    // ===== SIMPLE WORKING GAME =====
    
    // Initialize game
    function initGame() {
      gamePoints = 0;
      gameMoves = 15;
      gameSelected = null;
      gameGrid = [];
      
      // Create grid
      for (let i = 0; i < gridSize; i++) {
        gameGrid[i] = [];
        for (let j = 0; j < gridSize; j++) {
          gameGrid[i][j] = gamePieces[Math.floor(Math.random() * gamePieces.length)];
        }
      }
      
      drawGame();
      updateGameStats();
      document.getElementById('game-status').textContent = 'Match 3+ pieces in a row or column!';
    }
    
    // Draw the game board
    function drawGame() {
      const board = document.getElementById('game-board');
      let html = '';
      
      for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize; j++) {
          html += `<div class="game-cell" id="cell_${i}_${j}" onclick="clickCell(${i}, ${j})">${gameGrid[i][j]}</div>`;
        }
        html += '<br>';
      }
      
      board.innerHTML = html;
    }
    
    // Handle cell clicks
    function clickCell(row, col) {
      if (gameMoves <= 0) return;
      
      const cellId = `cell_${row}_${col}`;
      const cell = document.getElementById(cellId);
      
      if (!gameSelected) {
        // Select first cell
        gameSelected = {row, col};
        cell.classList.add('selected');
      } else if (gameSelected.row === row && gameSelected.col === col) {
        // Deselect same cell
        cell.classList.remove('selected');
        gameSelected = null;
      } else if (Math.abs(gameSelected.row - row) + Math.abs(gameSelected.col - col) === 1) {
        // Swap adjacent cells
        const prevCell = document.getElementById(`cell_${gameSelected.row}_${gameSelected.col}`);
        prevCell.classList.remove('selected');
        
        // Do the swap
        const temp = gameGrid[gameSelected.row][gameSelected.col];
        gameGrid[gameSelected.row][gameSelected.col] = gameGrid[row][col];
        gameGrid[row][col] = temp;
        
        // Check for matches
        const matches = checkMatches();
        if (matches.length >= 3) {
          gameMoves--;
          handleMatches(matches);
        } else {
          // Swap back
          gameGrid[row][col] = gameGrid[gameSelected.row][gameSelected.col];
          gameGrid[gameSelected.row][gameSelected.col] = temp;
          document.getElementById('game-status').textContent = 'No matches! Try different pieces.';
          setTimeout(() => {
            document.getElementById('game-status').textContent = 'Match 3+ pieces in a row or column!';
          }, 2000);
        }
        
        gameSelected = null;
        drawGame();
        updateGameStats();
      } else {
        // Select new cell
        document.querySelectorAll('.game-cell').forEach(c => c.classList.remove('selected'));
        gameSelected = {row, col};
        cell.classList.add('selected');
      }
    }
    
    // Check for matches
    function checkMatches() {
      const matches = [];
      
      // Check horizontal
      for (let i = 0; i < gridSize; i++) {
        let count = 1;
        for (let j = 1; j < gridSize; j++) {
          if (gameGrid[i][j] === gameGrid[i][j-1]) {
            count++;
          } else {
            if (count >= 3) {
              for (let k = j - count; k < j; k++) {
                matches.push({row: i, col: k});
              }
            }
            count = 1;
          }
        }
        if (count >= 3) {
          for (let k = gridSize - count; k < gridSize; k++) {
            matches.push({row: i, col: k});
          }
        }
      }
      
      // Check vertical
      for (let j = 0; j < gridSize; j++) {
        let count = 1;
        for (let i = 1; i < gridSize; i++) {
          if (gameGrid[i][j] === gameGrid[i-1][j]) {
            count++;
          } else {
            if (count >= 3) {
              for (let k = i - count; k < i; k++) {
                matches.push({row: k, col: j});
              }
            }
            count = 1;
          }
        }
        if (count >= 3) {
          for (let k = gridSize - count; k < gridSize; k++) {
            matches.push({row: k, col: j});
          }
        }
      }
      
      return matches;
    }
    
    // Handle matches
    function handleMatches(matches) {
      // Calculate points
      const points = matches.length * 10;
      gamePoints += points;
      gameState.points += Math.floor(points / 2);
      
      // Animate matches
      matches.forEach(match => {
        const cell = document.getElementById(`cell_${match.row}_${match.col}`);
        if (cell) cell.classList.add('matched');
      });
      
      setTimeout(() => {
        // Remove matched pieces
        matches.forEach(match => {
          gameGrid[match.row][match.col] = null;
        });
        
        // Drop pieces
        for (let j = 0; j < gridSize; j++) {
          let writePos = gridSize - 1;
          for (let i = gridSize - 1; i >= 0; i--) {
            if (gameGrid[i][j] !== null) {
              if (writePos !== i) {
                gameGrid[writePos][j] = gameGrid[i][j];
                gameGrid[i][j] = null;
              }
              writePos--;
            }
          }
        }
        
        // Fill empty spaces
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if (gameGrid[i][j] === null) {
              gameGrid[i][j] = gamePieces[Math.floor(Math.random() * gamePieces.length)];
            }
          }
        }
        
        drawGame();
        
        // Check for new matches
        const newMatches = checkMatches();
        if (newMatches.length >= 3) {
          setTimeout(() => handleMatches(newMatches), 500);
        }
        
        updateGameStats();
        saveGameState();
        updateDisplay();
      }, 800);
      
      document.getElementById('game-status').textContent = `🎉 ${matches.length} pieces matched! +${Math.floor(points/2)} house points!`;
      showToast(`⚡ ${matches.length} piece match! +${Math.floor(points/2)} house points!`);
    }
    
    // Get hint
    function getGameHint() {
      if (gameState.points < 5) {
        showToast('💰 Need 5 house points for a hint!');
        return;
      }
      
      gameState.points -= 5;
      document.getElementById('game-status').textContent = '💡 Look for pieces that can form a line when swapped!';
      setTimeout(() => {
        document.getElementById('game-status').textContent = 'Match 3+ pieces in a row or column!';
      }, 3000);
      saveGameState();
      updateDisplay();
    }
    
    // Update game stats
    function updateGameStats() {
      document.getElementById('game-score').textContent = gamePoints;
      document.getElementById('moves-left').textContent = gameMoves;
      
      if (gameMoves <= 0) {
        let bonus = 0;
        if (gamePoints >= 150) bonus = 15;
        else if (gamePoints >= 100) bonus = 10;
        else if (gamePoints >= 50) bonus = 5;
        
        if (bonus > 0) {
          gameState.points += bonus;
          document.getElementById('game-status').textContent = `🏆 Game over! Bonus: +${bonus} house points!`;
          showToast(`🎉 Game complete! +${bonus} bonus house points!`);
        } else {
          document.getElementById('game-status').textContent = '🎮 Game over! Try again for better magical combinations!';
        }
        
        saveGameState();
        updateDisplay();
      }
    }
    
    // Make functions globally accessible
    window.initGame = initGame;
    window.clickCell = clickCell;
    window.getGameHint = getGameHint;

    // Initialize the app when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
